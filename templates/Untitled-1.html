<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Braintree Food Pantry ‚Äî Admin</title>
  
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --sidebar-bg: #0f172a; /* slate-900 */
      --sidebar-hover: #1e293b; /* slate-800 */
      --accent: #22d3ee; /* cyan-400 */
    }

    body {
      min-height: 100vh;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,0.08), transparent),
                  radial-gradient(1200px 600px at 90% 110%, rgba(99,102,241,0.08), transparent);
    }

    .sidebar {
      background: var(--sidebar-bg);
      min-height: 100vh;
    }

    .sidebar .nav-link {
      color: rgba(255,255,255,0.85);
      border-radius: .75rem;
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .625rem .75rem;
    }

    .sidebar .nav-link:hover { background: var(--sidebar-hover); color: #fff; }

    .sidebar .nav-link.active {
      background: linear-gradient(135deg, rgba(34,211,238,.25), rgba(99,102,241,.25));
      color: #fff;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 0 0 1px rgba(34,211,238,.25) inset;
    }

    .brand-badge { border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: .5rem .75rem; background: rgba(255,255,255,0.03); }

    .card-ghost { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 1rem; backdrop-filter: blur(4px); }

    .table thead th { position: sticky; top: 0; background: rgba(15,23,42,.95); }

    .stat { border: 1px solid rgba(255,255,255,0.08); border-radius: .75rem; padding: .75rem 1rem; background: rgba(255,255,255,0.03); }

    .avatar-sm { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); }

    .testi-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 1rem; padding: 1rem; height: 100%; }
    .testi-photo { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }
    .testi-quote { font-style: italic; opacity: .95; }

    @media (max-width: 991.98px) { .sidebar { min-height: auto; } }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-12 col-lg-2 p-3 sidebar">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="brand-badge fw-semibold"><i class="bi bi-basket2 me-2"></i>Braintree Food Pantry</span>
          <button class="btn btn-outline-light d-lg-none" data-bs-toggle="collapse" data-bs-target="#adminNav"><i class="bi bi-list"></i></button>
        </div>
        <div id="adminNav" class="collapse d-lg-block">
          <div class="text-secondary text-uppercase small mb-2">Admin</div>
          <ul class="nav nav-pills flex-column gap-1" id="admin-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-edit" data-bs-toggle="pill" data-bs-target="#pane-edit" type="button" role="tab" aria-controls="pane-edit" aria-selected="true">
                <i class="bi bi-pencil-square"></i> Edit Website
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-messages" data-bs-toggle="pill" data-bs-target="#pane-messages" type="button" role="tab" aria-controls="pane-messages" aria-selected="false">
                <i class="bi bi-chat-dots"></i> User Messages
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-donations" data-bs-toggle="pill" data-bs-target="#pane-donations" type="button" role="tab" aria-controls="pane-donations" aria-selected="false">
                <i class="bi bi-credit-card"></i> Donations
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-testimonials" data-bs-toggle="pill" data-bs-target="#pane-testimonials" type="button" role="tab" aria-controls="pane-testimonials" aria-selected="false">
                <i class="bi bi-people"></i> Testimonials
              </button>
            </li>
          </ul>
          <hr class="border-secondary my-3" />
          <div class="d-grid gap-2">
            <button id="btnLogout" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right me-1"></i>Logout</button>
          </div>
        </div>
      </nav>

      <!-- Main -->
      <main class="col-12 col-lg-10 px-4 py-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
          <div>
            <h1 class="h3 mb-1">Admin Dashboard</h1>
            <div class="text-secondary">Manage site content, review messages, and track donations.</div>
          </div>
          <div class="d-flex gap-2">
            <span class="stat"><i class="bi bi-envelope-open me-1"></i><span id="statUnread">0</span> unread</span>
            <span class="stat"><i class="bi bi-cash-coin me-1"></i>$<span id="statTotal">0.00</span> total</span>
          </div>
        </div>

        <div class="tab-content" id="admin-tabContent">
          <!-- EDIT WEBSITE -->
          <section class="tab-pane fade show active" id="pane-edit" role="tabpanel" aria-labelledby="tab-edit" tabindex="0">
            <div class="row g-3">
              <div class="col-12 col-xl-8">
                <div class="card-ghost p-3">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h2 class="h5 mb-0"><i class="bi bi-brush me-2"></i>Site Content</h2>
                    <button class="btn btn-sm btn-outline-secondary" id="btnLoadDemo"><i class="bi bi-magic me-1"></i>Load demo</button>
                  </div>
                  <form id="siteForm" class="needs-validation" novalidate>

                    <div class="mb-3">
                      <label class="form-label" for="mission">Mission Statement</label>
                      <textarea id="mission" class="form-control" rows="3" placeholder="Our mission is to‚Ä¶" required></textarea>
                      <div class="invalid-feedback">Please add a mission statement.</div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label" for="about">About Section</label>
                      <textarea id="about" class="form-control" rows="5" placeholder="About the pantry‚Ä¶" required></textarea>
                      <div class="invalid-feedback">Please add an about section.</div>
                    </div>

                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label" for="address">Address</label>
                        <input id="address" type="text" class="form-control" placeholder="123 Main St, Braintree, MA" required />
                        <div class="invalid-feedback">Address is required.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label" for="hours">Opening Hours</label>
                        <input id="hours" type="text" class="form-control" placeholder="Sat 10:00‚Äì12:00; Wed 4:00‚Äì6:00" required />
                        <div class="invalid-feedback">Please enter opening hours.</div>
                      </div>
                    </div>

                    <div class="row g-3 mt-0">
                      <div class="col-md-6">
                        <label class="form-label" for="email">Contact Email</label>
                        <input id="email" type="email" class="form-control" placeholder="info@braintreefoodpantry.org" required />
                        <div class="invalid-feedback">Valid email required.</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label" for="phone">Contact Phone</label>
                        <input id="phone" type="tel" class="form-control" placeholder="(555) 123‚Äë4567" />
                      </div>
                    </div>

                    <div class="row g-3 mt-0">
                      <div class="col-md-6">
                        <label class="form-label" for="facebook">Facebook URL</label>
                        <input id="facebook" type="url" class="form-control" placeholder="https://facebook.com/..." />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label" for="donateLink">Donate Link</label>
                        <input id="donateLink" type="url" class="form-control" placeholder="https://your-donate-page" />
                      </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                      <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save Changes</button>
                      <button type="button" id="btnReset" class="btn btn-outline-secondary">Reset</button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="col-12 col-xl-4">
                <div class="card-ghost p-3">
                  <h2 class="h6 mb-3"><i class="bi bi-lightning-charge me-2"></i>Quick Actions</h2>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-info" id="btnPreview"><i class="bi bi-eye me-1"></i>Preview on site</button>
                    <button class="btn btn-outline-warning" id="btnExport"><i class="bi bi-download me-1"></i>Export JSON</button>
                    <button class="btn btn-outline-success" id="btnImport"><i class="bi bi-upload me-1"></i>Import JSON</button>
                    <input id="importFile" type="file" accept="application/json" class="d-none" />
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- USER MESSAGES -->
          <section class="tab-pane fade" id="pane-messages" role="tabpanel" aria-labelledby="tab-messages" tabindex="0">
            <div class="card-ghost p-3">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                <h2 class="h5 mb-0"><i class="bi bi-chat-text me-2"></i>User Messages</h2>
                <div class="input-group input-group-sm" style="max-width: 320px;">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="msgSearch" type="search" class="form-control" placeholder="Search name, email, subject‚Ä¶" />
                </div>
              </div>

              <div class="table-responsive" style="max-height: 520px;">
                <table class="table table-sm align-middle table-hover mb-0">
                  <thead>
                    <tr>
                      <th style="width: 110px;">Date</th>
                      <th style="width: 180px;">Name</th>
                      <th>Email</th>
                      <th>Subject</th>
                      <th>Message</th>
                      <th style="width: 120px;">Status</th>
                      <th style="width: 140px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="messagesBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- DONATIONS -->
          <section class="tab-pane fade" id="pane-donations" role="tabpanel" aria-labelledby="tab-donations" tabindex="0">
            <div class="card-ghost p-3">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                <h2 class="h5 mb-0"><i class="bi bi-cash-coin me-2"></i>Donations</h2>
                <div class="d-flex align-items-center gap-2">
                  <div class="input-group input-group-sm" style="max-width: 320px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="donSearch" type="search" class="form-control" placeholder="Search donor, ref, method‚Ä¶" />
                  </div>
                  <button class="btn btn-sm btn-outline-success" id="btnAddDonation"><i class="bi bi-plus-circle me-1"></i>Add</button>
                </div>
              </div>

              <div class="table-responsive" style="max-height: 520px;">
                <table class="table table-sm align-middle table-hover mb-0">
                  <thead>
                    <tr>
                      <th style="width: 110px;">Date</th>
                      <th>Donor</th>
                      <th style="width: 140px;">Amount</th>
                      <th style="width: 120px;">Method</th>
                      <th>Reference</th>
                      <th>Notes</th>
                      <th style="width: 140px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="donationsBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- TESTIMONIALS -->
          <section class="tab-pane fade" id="pane-testimonials" role="tabpanel" aria-labelledby="tab-testimonials" tabindex="0">
            <div class="card-ghost p-3">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                <h2 class="h5 mb-0"><i class="bi bi-people me-2"></i>Testimonials</h2>
                <div class="d-flex align-items-center gap-2">
                  <div class="input-group input-group-sm" style="max-width: 320px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="testiSearch" type="search" class="form-control" placeholder="Search name, profession, message‚Ä¶" />
                  </div>
                  <button class="btn btn-sm btn-outline-success" id="btnAddTestimonial"><i class="bi bi-plus-circle me-1"></i>Add</button>
                </div>
              </div>

              <div class="table-responsive" style="max-height: 420px;">
                <table class="table table-sm align-middle table-hover mb-0">
                  <thead>
                    <tr>
                      <th style="width:72px;">Photo</th>
                      <th style="width:200px;">Name</th>
                      <th style="width:200px;">Profession</th>
                      <th>Message</th>
                      <th style="width:160px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="testimonialsBody"></tbody>
                </table>
              </div>
            </div>

            <div class="card-ghost p-3 mt-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h3 class="h6 mb-0"><i class="bi bi-eye me-2"></i>Live Preview</h3>
                <small class="text-secondary">This mirrors how it will appear on the public site.</small>
              </div>
              <div id="testimonialsPreview" class="row g-3 row-cols-1 row-cols-md-2 row-cols-xl-3"></div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- View Message Modal -->
  <div class="modal fade" id="viewMsgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-envelope-open me-2"></i>Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small text-secondary" id="viewMsgMeta"></div>
          <div id="viewMsgText" class="fs-6"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Donation Modal -->
  <div class="modal fade" id="addDonationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Donation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="donationForm" class="needs-validation" novalidate>
            <div class="mb-2">
              <label class="form-label" for="donDate">Date</label>
              <input id="donDate" type="date" class="form-control" required />
              <div class="invalid-feedback">Date is required.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="donName">Donor Name</label>
              <input id="donName" type="text" class="form-control" placeholder="Jane Doe" required />
              <div class="invalid-feedback">Donor name is required.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="donAmount">Amount (USD)</label>
              <input id="donAmount" type="number" step="0.01" min="0" class="form-control" placeholder="50.00" required />
              <div class="invalid-feedback">Amount is required.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="donMethod">Method</label>
              <select id="donMethod" class="form-select" required>
                <option value="">Choose‚Ä¶</option>
                <option>Cash</option>
                <option>Check</option>
                <option>Card</option>
                <option>Online</option>
              </select>
              <div class="invalid-feedback">Select a method.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="donRef">Reference</label>
              <input id="donRef" type="text" class="form-control" placeholder="#INV-1234" />
            </div>
            <div class="mb-2">
              <label class="form-label" for="donNotes">Notes</label>
              <textarea id="donNotes" class="form-control" rows="2" placeholder="Optional"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveDonation" class="btn btn-success"><i class="bi bi-check2-circle me-1"></i>Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Testimonial Modal -->
  <div class="modal fade" id="testimonialModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="testimonialModalTitle"><i class="bi bi-plus-circle me-2"></i>Add Testimonial</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="testimonialForm" class="needs-validation" novalidate>
            <input type="hidden" id="testiId" />
            <div class="mb-3 text-center">
              <img id="testImagePreview" class="testi-photo d-none mb-2" alt="Preview" />
              <div class="input-group">
                <input id="testImage" type="file" accept="image/*" class="form-control" />
                <button class="btn btn-outline-secondary" type="button" id="btnClearImage"><i class="bi bi-x-circle"></i></button>
              </div>
              <div class="form-text">Upload a square photo (JPG/PNG). Preview appears above.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="testName">Name</label>
              <input id="testName" type="text" class="form-control" placeholder="Jane Doe" required />
              <div class="invalid-feedback">Name is required.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="testRole">Profession / Role</label>
              <input id="testRole" type="text" class="form-control" placeholder="Volunteer" required />
              <div class="invalid-feedback">Profession/Role is required.</div>
            </div>
            <div class="mb-2">
              <label class="form-label" for="testMessage">Message</label>
              <textarea id="testMessage" class="form-control" rows="3" placeholder="Share their words‚Ä¶" required></textarea>
              <div class="invalid-feedback">Message is required.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveTestimonial" class="btn btn-success"><i class="bi bi-check2-circle me-1"></i>Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="toast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Saved.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    // --- Mock data (replace with API calls later) ---
    const demoMessages = [
      { id: 1, date: '2025-10-02', name: 'Sarah Kim', email: 'sarah@example.com', subject: 'Volunteer', text: 'I would like to volunteer this Saturday. What time should I arrive?', status: 'unread' },
      { id: 2, date: '2025-10-04', name: 'Mike Thompson', email: 'mike.t@example.com', subject: 'Food donation', text: 'We have canned goods to donate. Where can we drop them off?', status: 'read' },
      { id: 3, date: '2025-10-08', name: 'Anonymous', email: 'anon@na.com', subject: 'Hours', text: 'Are you open on holidays?', status: 'unread' },
    ];

    const demoDonations = [
      { id: 'd1', date: '2025-10-01', name: 'Jane Doe', amount: 120.00, method: 'Online', ref: 'WEB-9132', notes: 'Monthly pledge' },
      { id: 'd2', date: '2025-10-05', name: 'Acme Corp', amount: 500.00, method: 'Check', ref: 'CHK-5511', notes: 'Corporate match' },
      { id: 'd3', date: '2025-10-09', name: 'John Lee', amount: 75.50, method: 'Card', ref: 'POS-8842', notes: '' },
    ];

    const demoTestimonials = [
      { id: 't1', name: 'Linda P.', role: 'Neighbor', message: 'The pantry helped my family when we needed it most. Thank you!', image: '' },
      { id: 't2', name: 'Carlos M.', role: 'Volunteer', message: 'A welcoming team and meaningful work every week.', image: '' },
    ];

    // LocalStorage keys
    const LS_KEYS = {
      SITE: 'bfp_site_content',
      MSGS: 'bfp_messages',
      DONS: 'bfp_donations',
      TESTS: 'bfp_testimonials'
    };

    // Utilities
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtMoney = (n) => (Number(n) || 0).toFixed(2);

    function loadStore(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : structuredClone(fallback);
      } catch { return structuredClone(fallback); }
    }

    function saveStore(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    function showToast(msg) {
      $('#toastBody').textContent = msg;
      const t = new bootstrap.Toast($('#toast'));
      t.show();
    }

    // --- Site Content Form ---
    const siteDefaults = { mission:'', about:'', address:'', hours:'', email:'', phone:'', facebook:'', donateLink:'' };

    function populateSiteForm(data) { for (const [k,v] of Object.entries(data)) { const el = document.getElementById(k); if (el) el.value = v || ''; } }
    function readSiteForm() { const data = {}; for (const k of Object.keys(siteDefaults)) { const el = document.getElementById(k); data[k] = el ? el.value.trim() : ''; } return data; }
    function validateForm(form) { form.classList.add('was-validated'); return form.checkValidity(); }

    // --- Messages Table ---
    function renderMessages(filter = '') {
      const tbody = $('#messagesBody');
      const msgs = loadStore(LS_KEYS.MSGS, demoMessages);
      const q = filter.toLowerCase();
      tbody.innerHTML = '';
      msgs
        .filter(m => (m.name + m.email + m.subject + m.text).toLowerCase().includes(q))
        .sort((a,b) => b.date.localeCompare(a.date))
        .forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-nowrap">${m.date}</td>
            <td>${m.name}</td>
            <td class="text-break"><a href="mailto:${m.email}">${m.email}</a></td>
            <td>${m.subject}</td>
            <td class="text-truncate" style="max-width: 320px;" title="${m.text}">${m.text}</td>
            <td>
              <span class="badge ${m.status === 'unread' ? 'text-bg-warning' : 'text-bg-secondary'}">${m.status}</span>
            </td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-info me-1" data-view="${m.id}"><i class="bi bi-eye"></i></button>
              <button class="btn btn-sm btn-outline-success me-1" data-toggle-read="${m.id}"><i class="bi bi-envelope-open"></i></button>
              <button class="btn btn-sm btn-outline-danger" data-delete="${m.id}"><i class="bi bi-trash"></i></button>
            </td>`;
          tbody.appendChild(tr);
        });
      updateUnreadStat();
    }

    function updateUnreadStat() {
      const msgs = loadStore(LS_KEYS.MSGS, demoMessages);
      const unread = msgs.filter(m => m.status === 'unread').length;
      $('#statUnread').textContent = unread;
    }

    // --- Donations Table ---
    function renderDonations(filter = '') {
      const tbody = $('#donationsBody');
      const dons = loadStore(LS_KEYS.DONS, demoDonations);
      const q = filter.toLowerCase();
      tbody.innerHTML = '';
      let total = 0;
      dons
        .filter(d => (d.name + d.method + d.ref + (d.notes||'')).toLowerCase().includes(q))
        .sort((a,b) => b.date.localeCompare(a.date))
        .forEach(d => {
          total += Number(d.amount) || 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-nowrap">${d.date}</td>
            <td>${d.name}</td>
            <td>$${fmtMoney(d.amount)}</td>
            <td>${d.method}</td>
            <td>${d.ref || ''}</td>
            <td class="text-break">${d.notes || ''}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-danger" data-delete-don="${d.id}"><i class="bi bi-trash"></i></button>
            </td>`;
          tbody.appendChild(tr);
        });
      $('#statTotal').textContent = fmtMoney(total);
    }

    // --- Testimonials ---
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderTestimonials(filter = '') {
      const tbody = $('#testimonialsBody');
      const tests = loadStore(LS_KEYS.TESTS, demoTestimonials);
      const q = filter.toLowerCase();
      tbody.innerHTML = '';
      tests
        .filter(t => (t.name + t.role + t.message).toLowerCase().includes(q))
        .forEach(t => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.image ? `<img src="${t.image}" class="avatar-sm" alt="${t.name}">` : '<div class="avatar-sm d-inline-flex align-items-center justify-content-center bg-secondary-subtle">üôÇ</div>'}</td>
            <td>${t.name}</td>
            <td>${t.role}</td>
            <td class="text-truncate" style="max-width: 360px;" title="${t.message}">${t.message}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-info me-1" data-edit-test="${t.id}"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger" data-del-test="${t.id}"><i class="bi bi-trash"></i></button>
            </td>`;
          tbody.appendChild(tr);
        });
      renderTestimonialsPreview();
    }

    function renderTestimonialsPreview() {
      const wrap = $('#testimonialsPreview');
      const tests = loadStore(LS_KEYS.TESTS, demoTestimonials);
      wrap.innerHTML = '';
      tests.forEach(t => {
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = `
          <div class="testi-card h-100 text-center">
            <img src="${t.image || 'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'35\' r=\'20\' fill=\'%23aaa\'/><rect x=\'20\' y=\'60\' width=\'60\' height=\'30\' rx=\'15\' fill=\'%23aaa\'/></svg>'}" class="testi-photo mb-3" alt="${t.name}">
            <div class="testi-quote">‚Äú${t.message.replaceAll('"','\"')}‚Äù</div>
            <div class="mt-2 fw-semibold">${t.name}</div>
            <div class="text-secondary small">${t.role}</div>
          </div>`;
        wrap.appendChild(col);
      });
    }

    // Open Add modal
    $('#btnAddTestimonial').addEventListener('click', () => {
      $('#testimonialForm').reset();
      $('#testimonialForm').classList.remove('was-validated');
      $('#testiId').value = '';
      $('#testImagePreview').classList.add('d-none');
      $('#testImage').value = '';
      $('#testimonialModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add Testimonial';
      new bootstrap.Modal('#testimonialModal').show();
    });

    // Search
    $('#testiSearch').addEventListener('input', e => renderTestimonials(e.target.value));

    // Image preview & clear
    $('#testImage').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) { $('#testImagePreview').classList.add('d-none'); return; }
      const dataUrl = await fileToDataUrl(file);
      $('#testImagePreview').src = dataUrl;
      $('#testImagePreview').classList.remove('d-none');
    });
    $('#btnClearImage').addEventListener('click', () => {
      $('#testImage').value = '';
      $('#testImagePreview').classList.add('d-none');
      $('#testImagePreview').removeAttribute('src');
    });

    // Save (Add/Edit)
    $('#saveTestimonial').addEventListener('click', async () => {
      const form = $('#testimonialForm');
      if (!validateForm(form)) return;
      const id = $('#testiId').value || `t${crypto.randomUUID?.() || Math.random().toString(36).slice(2)}`;
      const name = $('#testName').value.trim();
      const role = $('#testRole').value.trim();
      const message = $('#testMessage').value.trim();
      let image = '';

      const file = $('#testImage').files?.[0];
      if (file) { image = await fileToDataUrl(file); }
      else if ($('#testImagePreview').getAttribute('src')) { image = $('#testImagePreview').getAttribute('src'); }

      let tests = loadStore(LS_KEYS.TESTS, demoTestimonials);
      const idx = tests.findIndex(t => String(t.id) === String(id));
      const payload = { id, name, role, message, image };
      if (idx >= 0) tests[idx] = payload; else tests.push(payload);
      saveStore(LS_KEYS.TESTS, tests);
      renderTestimonials($('#testiSearch').value);
      bootstrap.Modal.getInstance($('#testimonialModal')).hide();
      showToast('Testimonial saved.');
    });

    // Edit/Delete buttons (delegated)
    document.addEventListener('click', async (e) => {
      const del = e.target.closest('[data-del-test]');
      if (del) {
        const id = del.getAttribute('data-del-test');
        let tests = loadStore(LS_KEYS.TESTS, demoTestimonials);
        tests = tests.filter(t => String(t.id) !== String(id));
        saveStore(LS_KEYS.TESTS, tests);
        renderTestimonials($('#testiSearch').value);
        showToast('Testimonial deleted.');
      }

      const edit = e.target.closest('[data-edit-test]');
      if (edit) {
        const id = edit.getAttribute('data-edit-test');
        const tests = loadStore(LS_KEYS.TESTS, demoTestimonials);
        const t = tests.find(x => String(x.id) === String(id));
        if (!t) return;
        $('#testimonialForm').classList.remove('was-validated');
        $('#testiId').value = t.id;
        $('#testName').value = t.name;
        $('#testRole').value = t.role;
        $('#testMessage').value = t.message;
        if (t.image) {
          $('#testImagePreview').src = t.image;
          $('#testImagePreview').classList.remove('d-none');
        } else {
          $('#testImagePreview').classList.add('d-none');
          $('#testImagePreview').removeAttribute('src');
        }
        $('#testImage').value = '';
        $('#testimonialModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Testimonial';
        new bootstrap.Modal('#testimonialModal').show();
      }
    });

    // --- Donations add flow ---
    $('#btnAddDonation').addEventListener('click', () => {
      $('#donationForm').reset();
      $('#donationForm').classList.remove('was-validated');
      new bootstrap.Modal('#addDonationModal').show();
    });

    $('#saveDonation').addEventListener('click', () => {
      const form = $('#donationForm');
      if (!validateForm(form)) return;
      const newDon = {
        id: `d${crypto.randomUUID?.() || Math.random().toString(36).slice(2)}`,
        date: $('#donDate').value,
        name: $('#donName').value.trim(),
        amount: parseFloat($('#donAmount').value || '0'),
        method: $('#donMethod').value,
        ref: $('#donRef').value.trim(),
        notes: $('#donNotes').value.trim()
      };
      const dons = loadStore(LS_KEYS.DONS, demoDonations);
      dons.push(newDon);
      saveStore(LS_KEYS.DONS, dons);
      renderDonations($('#donSearch').value);
      bootstrap.Modal.getInstance($('#addDonationModal')).hide();
      showToast('Donation added.');
    });

    // Search handlers
    $('#msgSearch').addEventListener('input', (e) => renderMessages(e.target.value));
    $('#donSearch').addEventListener('input', (e) => renderDonations(e.target.value));

    // Site form handlers
    $('#btnLoadDemo').addEventListener('click', () => {
      const demo = {
        mission: 'We provide nutritious food and support with dignity to neighbors in need across Braintree.',
        about: 'Founded in 1993, Braintree Food Pantry is a volunteer‚Äëdriven nonprofit serving families with monthly distributions and emergency assistance.',
        address: '594 Washington St, Braintree, MA 02184',
        hours: 'Sat 10:00‚Äì12:00; Wed 4:00‚Äì6:00',
        email: 'info@braintreefoodpantry.org',
        phone: '(781) 555‚Äë0123',
        facebook: 'https://facebook.com/braintreefoodpantry',
        donateLink: 'https://example.org/donate'
      };
      populateSiteForm(demo);
      showToast('Demo content loaded (not saved).');
    });

    $('#btnReset').addEventListener('click', () => {
      populateSiteForm(siteDefaults);
      $('#siteForm').classList.remove('was-validated');
    });

    $('#siteForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      if (!validateForm(form)) return;
      const data = readSiteForm();
      saveStore(LS_KEYS.SITE, data);
      showToast('Changes saved locally. (Hook to Flask later.)');
    });

    // Export / Import JSON
    $('#btnExport').addEventListener('click', () => {
      const data = readSiteForm();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'site-content.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    $('#btnImport').addEventListener('click', () => $('#importFile').click());
    $('#importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        populateSiteForm({ ...siteDefaults, ...json });
        showToast('Imported JSON (not saved yet).');
      } catch (err) { showToast('Invalid JSON file.'); }
      e.target.value = '';
    });

    // Preview (placeholder for routing to public site)
    $('#btnPreview').addEventListener('click', () => { window.open('https://unstevable.github.io/BraintreeFoodPantry/', '_blank'); });

    // Logout (placeholder)
    $('#btnLogout').addEventListener('click', () => { showToast('Logged out (placeholder).'); });

    // Initial load
    (function init() {
      // Site form from localStorage
      const saved = loadStore(LS_KEYS.SITE, siteDefaults);
      populateSiteForm(saved);
      // Tables
      renderMessages();
      renderDonations();
      renderTestimonials();
    })();
  </script>
</body>
</html>
